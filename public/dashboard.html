<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kimland App - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .sync-progress {
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">üîç Kimland App</h1>
                        <p class="text-sm text-gray-600">Synchronisation Shopify ‚Üî Kimland</p>
                    </div>
                    <div id="shop-status" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Connexion...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="loading" class="text-center py-12">
                <div class="loading text-4xl mb-4">‚è≥</div>
                <p class="text-gray-600">Chargement de votre boutique...</p>
            </div>

            <div id="dashboard" style="display: none;">
                <!-- Connection Status Banner -->
                <div id="kimland-connection-banner" class="bg-white rounded-lg shadow mb-6 border-l-4 border-orange-400">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div id="kimland-connection-icon" class="w-4 h-4 bg-orange-400 rounded-full mr-3 animate-pulse"></div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-900">√âtat Connexion Kimland</h3>
                                    <p id="kimland-connection-status" class="text-sm text-gray-600">V√©rification en cours...</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="testKimlandConnection()" class="bg-blue-600 text-white px-3 py-1 text-sm rounded-md hover:bg-blue-700">
                                    üîó Test
                                </button>
                                <button onclick="forceReconnectKimland()" class="bg-orange-600 text-white px-3 py-1 text-sm rounded-md hover:bg-orange-700">
                                    üîÑ Reconnecter
                                </button>
                            </div>
                        </div>
                        <div id="kimland-connection-details" class="mt-2 text-xs text-gray-500" style="display: none;">
                            <!-- D√©tails de connexion seront ajout√©s ici -->
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-2xl font-bold text-gray-900" id="total-products">-</div>
                        <div class="text-sm text-gray-600">Total Produits</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-2xl font-bold text-green-600" id="with-references">-</div>
                        <div class="text-sm text-gray-600">Avec R√©f√©rences</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-2xl font-bold text-blue-600" id="sync-success">-</div>
                        <div class="text-sm text-gray-600">Sync R√©ussie</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-2xl font-bold text-red-600" id="sync-errors">-</div>
                        <div class="text-sm text-gray-600">Erreurs Sync</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-2xl font-bold text-purple-600" id="last-sync">-</div>
                        <div class="text-sm text-gray-600">Derni√®re Sync</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-2xl font-bold text-orange-600" id="kimland-status">-</div>
                        <div class="text-sm text-gray-600">Kimland</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="px-6 py-4 border-b">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input 
                                type="text" 
                                id="search-input" 
                                placeholder="Rechercher un produit..."
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div class="flex gap-2">
                                <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                    üîÑ Actualiser
                                </button>
                                <button onclick="updateAllSKU()" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700">
                                    üè∑Ô∏è MAJ SKU
                                </button>
                                <button onclick="syncAllInventory()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                    üì¶ Sync Inventaire
                                </button>
                                <button onclick="exportData()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                                    üì• Exporter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex">
                            <button onclick="switchTab('products')" id="tab-products" class="py-2 px-4 border-b-2 border-green-500 text-green-600 font-medium text-sm">
                                üì¶ Produits
                            </button>
                            <button onclick="switchTab('sync-history')" id="tab-sync-history" class="py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                                üìä Historique Sync
                            </button>
                            <button onclick="switchTab('settings')" id="tab-settings" class="py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                                ‚öôÔ∏è Param√®tres
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Products Tab -->
                <div id="tab-content-products" class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">Produits avec R√©f√©rences</h2>
                    </div>
                    <div id="products-list" class="divide-y divide-gray-200">
                        <!-- Products will be loaded here -->
                    </div>
                </div>

                <!-- Sync History Tab -->
                <div id="tab-content-sync-history" class="bg-white rounded-lg shadow" style="display: none;">
                    <div class="px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">Historique des Synchronisations</h2>
                    </div>
                    <div id="sync-history-list" class="divide-y divide-gray-200">
                        <div class="p-6 text-center text-gray-500">Aucun historique de synchronisation</div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="tab-content-settings" class="bg-white rounded-lg shadow" style="display: none;">
                    <div class="px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">Param√®tres Kimland</h2>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">URL Kimland</label>
                                <input type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" value="https://kimland.dz" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Statut Connexion</label>
                                <div class="mt-1 flex items-center">
                                    <div id="kimland-status-indicator" class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></div>
                                    <span id="kimland-status-text" class="text-sm text-gray-900">V√©rification...</span>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="testKimlandConnection()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                    üîó Test Connexion
                                </button>
                                <button onclick="clearKimlandSession()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                    üóëÔ∏è Vider Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="error" style="display: none;" class="text-center py-12">
                <div class="text-4xl mb-4">‚ùå</div>
                <p class="text-gray-600 mb-4">Erreur de connexion √† votre boutique</p>
                <button onclick="window.location.reload()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700">
                    R√©essayer
                </button>
            </div>
        </main>
    </div>

    <!-- Modal pour le progr√®s de sync -->
    <div id="sync-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Synchronisation en cours</h3>
                <div class="flex items-center space-x-2">
                    <!-- üö´ Bouton d'arr√™t -->
                    <button id="cancel-sync-btn" onclick="cancelSync()" 
                            class="bg-red-600 text-white px-3 py-1 text-sm rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            style="display: none;">
                        üö´ Arr√™ter
                    </button>
                    <button onclick="closeSyncModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>
            </div>
            <div id="sync-progress-container">
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div id="sync-progress-bar" class="sync-progress h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-sm text-gray-600 mb-4" id="sync-status">Pr√©paration...</div>
                <div id="sync-results" class="max-h-60 overflow-y-auto"></div>
                
                <!-- Zone d'information sur l'arr√™t -->
                <div id="cancel-info" class="bg-yellow-50 border border-yellow-200 rounded p-3 mt-4" style="display: none;">
                    <div class="flex items-center">
                        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
                        <span class="text-sm text-yellow-800">Arr√™t en cours... Finalisation des op√©rations actuelles.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentShop = null;
        let syncResults = [];
        let currentTab = 'products';

        // Get shop from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentShop = urlParams.get('shop');

        if (!currentShop) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        } else {
            loadDashboard();
        }

        async function loadDashboard() {
            console.log('üöÄ Chargement du dashboard', { currentShop });
            
            try {
                updateStatus('connecting', 'Connexion √† ' + currentShop);
                updateKimlandStatus('checking', 'V√©rification...');
                
                console.log('üì° R√©cup√©ration des produits Shopify', { shop: currentShop });
                const response = await fetch(`/api/products?shop=${encodeURIComponent(currentShop)}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Erreur API produits:', errorData);
                    
                    if (errorData.error === 'AUTH_REQUIRED' && errorData.install_url) {
                        console.log('üîÑ Redirection vers installation Shopify');
                        window.location.href = `/auth/install?shop=${encodeURIComponent(currentShop)}`;
                        return;
                    }
                    
                    throw new Error('Erreur de connexion: ' + (errorData.message || response.statusText));
                }

                const data = await response.json();
                console.log('‚úÖ Donn√©es produits re√ßues:', { success: data.success, productsCount: data.products?.length });
                
                if (data.success) {
                    updateStatus('connected', currentShop);
                    displayProducts(data.products || []);
                    updateStats(data.products || []);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';

                    // Charger l'historique de sync
                    console.log('üìä Chargement historique sync');
                    loadSyncHistory();
                    
                    // V√©rifier la connexion Kimland de fa√ßon d√©taill√©e
                    console.log('üîç V√©rification connexion Kimland');
                    checkKimlandStatusDetailed();
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement dashboard:', error);
                updateStatus('error', 'Erreur');
                updateKimlandStatus('error', 'Erreur de chargement');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function switchTab(tabName) {
            // Masquer tous les contenus de tab
            document.querySelectorAll('[id^="tab-content-"]').forEach(el => el.style.display = 'none');
            
            // R√©initialiser tous les boutons de tab
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.className = el.className.replace('border-green-500 text-green-600', 'border-transparent text-gray-500 hover:text-gray-700');
            });
            
            // Activer le tab s√©lectionn√©
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            document.getElementById(`tab-${tabName}`).className = document.getElementById(`tab-${tabName}`).className.replace('border-transparent text-gray-500 hover:text-gray-700', 'border-green-500 text-green-600');
            
            currentTab = tabName;
        }

        function updateStatus(status, shop) {
            const statusEl = document.getElementById('shop-status');
            const colors = {
                connecting: 'bg-yellow-400',
                connected: 'bg-green-400', 
                error: 'bg-red-400'
            };
            
            statusEl.innerHTML = `
                <div class="w-3 h-3 ${colors[status]} rounded-full"></div>
                <span class="text-sm text-gray-600">${shop}</span>
            `;
        }

        function displayProducts(products) {
            const container = document.getElementById('products-list');
            
            if (!products.length) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">Aucun produit trouv√©</div>';
                return;
            }

            container.innerHTML = products.map(product => `
                <div class="px-6 py-4 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-gray-900">${product.title}</h3>
                            <p class="text-xs text-gray-400">ID: ${product.id}</p>
                            <p class="text-sm text-gray-500">
                                SKU: <strong class="${product.variants?.[0]?.sku ? 'text-green-600' : 'text-red-500'}">
                                    ${product.variants?.[0]?.sku || 'Aucun'}
                                </strong>
                            </p>
                            <p class="text-xs text-gray-400">Stock: ${product.variants?.reduce((total, v) => total + (v.inventory_quantity || 0), 0) || 0}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="text-sm text-gray-500">
                                ${product.variants?.length || 0} variant(s)
                            </div>
                            ${product.variants?.[0]?.sku ? `
                                <button onclick="syncProductInventory(${product.id})" class="bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600">
                                    üì¶ Sync Stock
                                </button>
                            ` : `
                                <button onclick="updateSKU(${product.id})" class="bg-blue-500 text-white text-xs px-3 py-1 rounded hover:bg-blue-600">
                                    üè∑Ô∏è MAJ SKU
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats(products) {
            const withSku = products.filter(p => p.variants?.[0]?.sku);
            const syncSuccess = syncResults.filter(r => r.syncStatus === 'success').length;
            const syncErrors = syncResults.filter(r => r.syncStatus === 'error').length;
            
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('with-references').textContent = withSku.length;
            document.getElementById('sync-success').textContent = syncSuccess;
            document.getElementById('sync-errors').textContent = syncErrors;
            document.getElementById('last-sync').textContent = syncResults.length > 0 ? 'R√©cente' : 'Jamais';
        }

        async function syncProductInventory(productId) {
            try {
                console.log('üì¶ D√©but sync produit:', { productId, shop: currentShop });
                
                const response = await fetch(`/api/sync/product/${productId}?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'POST'
                });
                
                console.log('üì° R√©ponse sync produit:', { ok: response.ok, status: response.status });
                
                const result = await response.json();
                console.log('üì• Donn√©es sync produit:', result);
                
                if (result.success) {
                    console.log('‚úÖ Sync produit r√©ussie:', result);
                    alert(`Stock synchronis√© avec succ√®s!\nSKU: ${result.syncResult?.sku}\nStock Kimland: ${result.kimlandStock}\nStock mis √† jour sur Shopify: ${result.updatedQuantity}`);
                    loadDashboard();
                } else {
                    console.error('‚ùå Sync produit √©chou√©e:', result);
                    
                    // Afficher d√©tails de l'erreur si c'est une erreur d'auth Kimland
                    let errorMsg = result.error || 'Erreur inconnue';
                    if (result.syncResult?.errorMessage) {
                        errorMsg += '\nD√©tail: ' + result.syncResult.errorMessage;
                    }
                    
                    alert(`‚ùå Erreur de synchronisation: ${errorMsg}\n\nD√©bogage: ${JSON.stringify(result.syncResult, null, 2)}`);
                    
                    // Si c'est une erreur d'auth, v√©rifier le statut Kimland
                    if (result.syncResult?.errorMessage?.includes('authentification')) {
                        console.log('üîç Erreur auth d√©tect√©e, v√©rification statut Kimland');
                        checkKimlandStatusDetailed();
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau sync produit:', error);
                alert('‚ùå Erreur de connexion lors de la synchronisation: ' + error.message);
            }
        }

        async function syncAllInventory() {
            if (!confirm('Synchroniser l\'inventaire de tous les produits avec Kimland ?')) {
                return;
            }

            showSyncModal();
            
            try {
                const response = await fetch(`/api/sync/inventory/all?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Erreur de synchronisation');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                let buffer = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Garder la ligne incompl√®te

                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const data = JSON.parse(line);
                                updateSyncProgress(data);
                            } catch (e) {
                                console.log('Non-JSON line:', line);
                            }
                        }
                    }
                }

                // Traiter la derni√®re ligne si elle existe
                if (buffer.trim()) {
                    try {
                        const data = JSON.parse(buffer);
                        updateSyncProgress(data);
                    } catch (e) {
                        console.log('Non-JSON final line:', buffer);
                    }
                }

            } catch (error) {
                console.error('Erreur sync globale:', error);
                updateSyncStatus('Erreur de synchronisation: ' + error.message);
            }
        }

        function showSyncModal() {
            document.getElementById('sync-modal').style.display = 'block';
            document.getElementById('sync-progress-bar').style.width = '0%';
            document.getElementById('sync-status').textContent = 'Pr√©paration...';
            document.getElementById('sync-results').innerHTML = '';
            
            // Masquer les √©l√©ments d'arr√™t initialement
            document.getElementById('cancel-sync-btn').style.display = 'none';
            document.getElementById('cancel-info').style.display = 'none';
            isSyncCancelled = false;
        }

        function closeSyncModal() {
            // Si une synchronisation est en cours, demander confirmation
            if (syncAbortController && !isSyncCancelled) {
                if (confirm('üö´ Voulez-vous vraiment arr√™ter la synchronisation en cours ?')) {
                    cancelSync();
                } else {
                    return; // Ne pas fermer si l'utilisateur annule
                }
            }
            
            document.getElementById('sync-modal').style.display = 'none';
            loadDashboard(); // Recharger les donn√©es
        }

function updateSyncProgress(data) {
console.log('üìä Progr√®s sync re√ßu:', data);

if (data.type === 'info') {
updateSyncStatus(`‚ÑπÔ∏è ${data.message}`);
    
// Afficher le bouton d'arr√™t si la synchronisation peut √™tre annul√©e
if (data.canCancel) {
    showCancelButton();
}

} else if (data.type === 'progress') {
const progress = data.percentage || Math.round((data.current / data.total) * 100);

// üìä Mise √† jour de la barre de progression
const progressBar = document.getElementById('sync-progress-bar');
if (progressBar) {
progressBar.style.width = progress + '%';
progressBar.style.transition = 'width 0.3s ease';
}

// üìù Mise √† jour du status avec plus de d√©tails
    updateSyncStatus(`
    üîÑ ${data.message} 
    <br><small>${data.current}/${data.total} (${progress}%)</small>
    ${data.productName ? `<br><small>üì¶ ${data.productName}</small>` : ''}
`);

// Afficher le bouton d'arr√™t si possible
if (data.canCancel) {
    showCancelButton();
}

} else if (data.type === 'result') {
const resultDiv = document.getElementById('sync-results');
if (!resultDiv) return;

const timestamp = new Date(data.timestamp).toLocaleTimeString();
const statusClass = data.success ? 'text-green-600' : 'text-red-600';
const statusIcon = data.success ? '‚úÖ' : '‚ùå';

// üé® HTML am√©lior√© pour les r√©sultats
const resultHtml = `
<div class="sync-result-item border-l-4 ${data.success ? 'border-green-400' : 'border-red-400'} pl-3 py-2 mb-2 bg-gray-50 rounded">
<div class="flex justify-between items-start">
<div class="flex-1">
<div class="flex items-center">
    <span class="${statusClass} text-lg mr-2">${statusIcon}</span>
        <strong class="text-sm">${data.sku}</strong>
            <span class="text-xs text-gray-500 ml-2">${timestamp}</span>
            </div>
                ${data.productName ? `<div class="text-xs text-gray-600 ml-6">${data.productName}</div>` : ''}
                <div class="text-sm ml-6 ${statusClass}">${data.message}</div>
                ${data.kimlandStock !== undefined ? `
                    <div class="text-xs text-blue-600 ml-6">
                        üì¶ Stock: ${data.kimlandStock} 
                            ${data.variantsCount ? `| ${data.variantsCount} variante(s)` : ''}
                    </div>
                ` : ''}
            </div>
        </div>
    </div>
`;

resultDiv.insertAdjacentHTML('beforeend', resultHtml);
resultDiv.scrollTop = resultDiv.scrollHeight;

} else if (data.type === 'cancelled') {
// üö´ Synchronisation annul√©e
updateSyncStatus(`
    üö´ <strong>Synchronisation arr√™t√©e!</strong>
<br>Arr√™t√©e √† l'√©tape ${data.stoppedAt || 0}
`);

hideCancelButton();
showCancelInfo('Synchronisation arr√™t√©e par l\'utilisateur');

// üîî Notification
if ('Notification' in window && Notification.permission === 'granted') {
new Notification('Synchronisation arr√™t√©e', {
        body: `Synchronisation interrompue √† l'√©tape ${data.stoppedAt || 0}`,
        icon: '/favicon.ico'
        });
}

} else if (data.type === 'complete') {
        // üèÅ Finalisation avec statistiques d√©taill√©es
                const successRate = data.successRate || 0;
                const duration = Math.round((data.duration || 0) / 1000);
                
                updateSyncStatus(`
                    üèÅ <strong>Synchronisation termin√©e!</strong>
                    <br>‚úÖ ${data.successful} r√©ussies 
                    <br>‚ùå ${data.failed} √©checs 
                    <br>üìä Taux de r√©ussite: ${successRate}%
                    <br>‚è±Ô∏è Dur√©e: ${duration}s
                `);
                
                hideCancelButton();
                
                // üîî Notification syst√®me si disponible
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Synchronisation termin√©e', {
                        body: `${data.successful}/${data.total} produits synchronis√©s avec succ√®s`,
                        icon: '/favicon.ico'
                    });
                }
                
                // üìä Mettre √† jour les statistiques du dashboard
                setTimeout(() => {
                    loadDashboard();
                }, 2000);
                
            } else if (data.type === 'error') {
                updateSyncStatus(`üí• <strong>Erreur critique:</strong><br>${data.message}`);
                hideCancelButton();
                console.error('Erreur sync critique:', data);
            }
        }

function updateSyncStatus(html) {
const statusEl = document.getElementById('sync-status');
if (statusEl) {
statusEl.innerHTML = html;
}
}

        // üö´ Nouvelles fonctions pour g√©rer l'arr√™t de synchronisation
        function cancelSync() {
            if (!syncAbortController || isSyncCancelled) {
                console.log('‚ö†Ô∏è Aucune synchronisation √† annuler');
                return;
            }
            
            console.log('üö´ D√©but annulation synchronisation');
            isSyncCancelled = true;
            
            // Annuler la requ√™te HTTP
            if (syncAbortController) {
                syncAbortController.abort();
                syncAbortController = null;
            }
            
            // Afficher le message d'arr√™t
            showCancelInfo('Arr√™t en cours... Finalisation des op√©rations actuelles.');
            
            // D√©sactiver le bouton
            const cancelBtn = document.getElementById('cancel-sync-btn');
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = '‚è≥ Arr√™t...';
            }
            
            updateSyncStatus('üö´ Arr√™t de la synchronisation en cours...');
        }
        
        function showCancelButton() {
            const cancelBtn = document.getElementById('cancel-sync-btn');
            if (cancelBtn && !isSyncCancelled) {
                cancelBtn.style.display = 'inline-block';
                cancelBtn.disabled = false;
                cancelBtn.innerHTML = 'üö´ Arr√™ter';
            }
        }
        
        function hideCancelButton() {
            const cancelBtn = document.getElementById('cancel-sync-btn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
        }
        
        function showCancelInfo(message) {
            const cancelInfo = document.getElementById('cancel-info');
            if (cancelInfo) {
                cancelInfo.style.display = 'block';
                const messageSpan = cancelInfo.querySelector('.text-yellow-800');
                if (messageSpan) {
                    messageSpan.textContent = message;
                }
            }
        }
        
        function hideCancelInfo() {
            const cancelInfo = document.getElementById('cancel-info');
            if (cancelInfo) {
                cancelInfo.style.display = 'none';
            }
        }

// üîî Demander permission pour notifications
window.addEventListener('load', () => {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});
            if (data.type === 'progress') {
                const progress = Math.round((data.current / data.total) * 100);
                document.getElementById('sync-progress-bar').style.width = progress + '%';
                document.getElementById('sync-status').textContent = 
                    `${data.message} (${data.current}/${data.total})`;
            } else if (data.type === 'result') {
                const resultDiv = document.getElementById('sync-results');
                const statusClass = data.success ? 'text-green-600' : 'text-red-600';
                const statusIcon = data.success ? '‚úÖ' : '‚ùå';
                
                resultDiv.innerHTML += `
                    <div class="text-sm py-1">
                        <span class="${statusClass}">${statusIcon}</span>
                        <strong>${data.sku}</strong>: ${data.message}
                        ${data.kimlandStock !== undefined ? `(Stock: ${data.kimlandStock})` : ''}
                    </div>
                `;
                resultDiv.scrollTop = resultDiv.scrollHeight;
            } else if (data.type === 'complete') {
                document.getElementById('sync-status').textContent = 
                    `Termin√©! ${data.successful} r√©ussies, ${data.failed} √©checs`;
                
                // Sauvegarder les r√©sultats
                syncResults = data.results || [];
                updateStats([]);
            }
        

        async function loadSyncHistory() {
            try {
                const response = await fetch(`/api/sync/history?shop=${encodeURIComponent(currentShop)}`);
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    const container = document.getElementById('sync-history-list');
                    container.innerHTML = data.history.map(sync => `
                        <div class="px-6 py-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">
                                        ${new Date(sync.date).toLocaleString('fr-FR')}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        ${sync.successful} r√©ussies, ${sync.failed} √©checs
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm ${sync.status === 'completed' ? 'text-green-600' : 'text-red-600'}">
                                        ${sync.status === 'completed' ? '‚úÖ Termin√©' : '‚ùå Erreur'}
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        ${sync.duration}ms
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erreur chargement historique:', error);
            }
        }

        // Fonction de mise √† jour du statut Kimland
        function updateKimlandStatus(status, message, details = null) {
            console.log('üîÑ Mise √† jour statut Kimland:', { status, message, details });
            
            const banner = document.getElementById('kimland-connection-banner');
            const icon = document.getElementById('kimland-connection-icon');
            const statusEl = document.getElementById('kimland-connection-status');
            const detailsEl = document.getElementById('kimland-connection-details');
            const statEl = document.getElementById('kimland-status');
            
            // Mise √† jour des couleurs et ic√¥nes
            const configs = {
                connected: {
                    bannerClass: 'border-green-400',
                    iconClass: 'w-4 h-4 bg-green-400 rounded-full mr-3',
                    stat: 'üü¢ OK'
                },
                error: {
                    bannerClass: 'border-red-400',
                    iconClass: 'w-4 h-4 bg-red-400 rounded-full mr-3',
                    stat: 'üî¥ KO'
                },
                checking: {
                    bannerClass: 'border-orange-400',
                    iconClass: 'w-4 h-4 bg-orange-400 rounded-full mr-3 animate-pulse',
                    stat: 'üü° ...'
                },
                disconnected: {
                    bannerClass: 'border-red-400',
                    iconClass: 'w-4 h-4 bg-red-400 rounded-full mr-3',
                    stat: '‚ö´ OFF'
                }
            };
            
            const config = configs[status] || configs.error;
            
            // Mettre √† jour l'apparence
            banner.className = `bg-white rounded-lg shadow mb-6 border-l-4 ${config.bannerClass}`;
            icon.className = config.iconClass;
            statusEl.textContent = message;
            statEl.textContent = config.stat;
            
            // Afficher les d√©tails si disponibles
            if (details) {
                detailsEl.innerHTML = `
                    <div class="bg-gray-50 p-2 rounded mt-2">
                        <pre class="text-xs">${JSON.stringify(details, null, 2)}</pre>
                    </div>
                `;
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
            }
        }

        async function checkKimlandStatusDetailed() {
            try {
                console.log('üîç D√©but v√©rification statut Kimland d√©taill√©e');
                updateKimlandStatus('checking', 'V√©rification connexion Kimland...');
                
                const response = await fetch('/api/kimland/status');
                console.log('üì° R√©ponse API kimland/status:', { 
                    ok: response.ok, 
                    status: response.status, 
                    statusText: response.statusText 
                });
                
                const data = await response.json();
                console.log('üì• Donn√©es statut Kimland:', data);
                
                // Mise √† jour des √©l√©ments de l'interface
                const indicator = document.getElementById('kimland-status-indicator');
                const text = document.getElementById('kimland-status-text');
                
                if (data.connected) {
                    console.log('‚úÖ Kimland connect√©');
                    updateKimlandStatus('connected', `Connect√© depuis ${data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : 'maintenant'}`, data);
                    
                    if (indicator) {
                        indicator.className = 'w-3 h-3 bg-green-400 rounded-full mr-2';
                    }
                    if (text) {
                        text.textContent = 'Connect√©';
                    }
                } else {
                    console.log('‚ùå Kimland d√©connect√©:', data.error);
                    updateKimlandStatus('disconnected', `D√©connect√©: ${data.error || 'Raison inconnue'}`, data);
                    
                    if (indicator) {
                        indicator.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                    }
                    if (text) {
                        text.textContent = 'D√©connect√©';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erreur v√©rification Kimland:', error);
                updateKimlandStatus('error', `Erreur de v√©rification: ${error.message}`, { error: error.toString() });
                
                const indicator = document.getElementById('kimland-status-indicator');
                const text = document.getElementById('kimland-status-text');
                
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                }
                if (text) {
                    text.textContent = 'Erreur de v√©rification';
                }
            }
        }

        async function testKimlandConnection() {
            try {
                console.log('üîó D√©but test connexion Kimland');
                updateKimlandStatus('checking', 'Test de connexion en cours...');
                
                const response = await fetch('/api/kimland/test', { method: 'POST' });
                console.log('üì° R√©ponse test Kimland:', { ok: response.ok, status: response.status });
                
                const data = await response.json();
                console.log('üì• Donn√©es test Kimland:', data);
                
                if (data.success) {
                    console.log('‚úÖ Test connexion Kimland r√©ussi');
                    updateKimlandStatus('connected', 'Test r√©ussi - Connexion op√©rationnelle', data);
                    alert('‚úÖ Connexion Kimland r√©ussie!\n' + JSON.stringify(data, null, 2));
                    checkKimlandStatusDetailed();
                } else {
                    console.error('‚ùå Test connexion Kimland √©chou√©:', data);
                    updateKimlandStatus('error', `Test √©chou√©: ${data.error}`, data);
                    alert('‚ùå Erreur de connexion: ' + data.error + '\nD√©tails: ' + JSON.stringify(data, null, 2));
                }
            } catch (error) {
                console.error('‚ùå Erreur test connexion Kimland:', error);
                updateKimlandStatus('error', 'Erreur durant le test', { error: error.toString() });
                alert('‚ùå Erreur de test de connexion: ' + error.message);
            }
        }
        
        async function forceReconnectKimland() {
            if (!confirm('Forcer une reconnexion √† Kimland ?\nCela va vider la session actuelle.')) {
                return;
            }
            
            try {
                console.log('üîÑ D√©but reconnexion forc√©e Kimland');
                updateKimlandStatus('checking', 'Reconnexion forc√©e en cours...');
                
                // Vider la session actuelle
                const clearResponse = await fetch('/api/kimland/clear-session', { method: 'POST' });
                const clearData = await clearResponse.json();
                console.log('üóëÔ∏è Session vid√©e:', clearData);
                
                // Forcer une nouvelle connexion
                const loginResponse = await fetch('/api/kimland/force-login', { method: 'POST' });
                const loginData = await loginResponse.json();
                console.log('üîê Reconnexion forc√©e:', loginData);
                
                if (loginData.success) {
                    console.log('‚úÖ Reconnexion Kimland r√©ussie');
                    updateKimlandStatus('connected', 'Reconnexion r√©ussie', loginData);
                    alert('‚úÖ Reconnexion Kimland r√©ussie!');
                    checkKimlandStatusDetailed();
                } else {
                    console.error('‚ùå Reconnexion Kimland √©chou√©e:', loginData);
                    updateKimlandStatus('error', `Reconnexion √©chou√©e: ${loginData.error}`, loginData);
                    alert('‚ùå Erreur de reconnexion: ' + loginData.error);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur reconnexion forc√©e Kimland:', error);
                updateKimlandStatus('error', 'Erreur durant la reconnexion', { error: error.toString() });
                alert('‚ùå Erreur de reconnexion: ' + error.message);
            }
        }

        async function clearKimlandSession() {
            if (!confirm('Vider la session Kimland ?')) return;
            
            try {
                const response = await fetch('/api/kimland/clear-session', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Session vid√©e');
                    checkKimlandStatus();
                } else {
                    alert('‚ùå Erreur: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors du vidage de session');
            }
        }

        function refreshData() {
            loadDashboard();
        }

        function exportData() {
            // TODO: Impl√©menter l'export
            alert('Fonctionnalit√© d\'export bient√¥t disponible!');
        }

        // Fonctions de mise √† jour SKU
        async function updateSKU(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/update-sku?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`SKU mis √† jour avec succ√®s: ${result.reference}`);
                    loadDashboard();
                } else {
                    alert(`Erreur: ${result.error}`);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        async function updateAllSKU() {
            if (!confirm('Mettre √† jour le SKU de TOUS les produits avec r√©f√©rences ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/products/update-all-sku?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Mise √† jour termin√©e:\n- ${result.updated} SKU mis √† jour\n- ${result.skipped} produits ignor√©s`);
                    loadDashboard();
                } else {
                    alert(`Erreur: ${result.error}`);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // Support touche Entr√©e pour la recherche
        document.getElementById('search-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    // TODO: Impl√©menter la recherche
                    console.log('Recherche:', searchTerm);
                }
            }
        });

        // Fermer le modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('sync-modal');
            if (event.target === modal) {
                closeSyncModal();
            }
        }
    </script>
</body>
</html>