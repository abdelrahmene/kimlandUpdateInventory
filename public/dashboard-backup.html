<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kimland App - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .sync-progress {
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Nouveaux styles pour l'UI am√©lior√©e */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #3B82F6, #6366F1, #8B5CF6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .search-highlight {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border: 2px solid #F59E0B;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
        }
        
        .result-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.8);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in-up {
            animation: slideInUp 0.3s ease-out;
        }
        
        .floating-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">üîç Kimland App</h1>
                        <p class="text-sm text-gray-600">Synchronisation Shopify ‚Üî Kimland</p>
                    </div>
                    <div id="shop-status" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Connexion...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="loading" class="text-center py-12">
                <div class="loading text-4xl mb-4">‚è≥</div>
                <p class="text-gray-600">Chargement de votre boutique...</p>
            </div>

            <div id="dashboard" style="display: none;">
                <!-- Interface principale √©pur√©e avec 2 boutons centraux -->
                <div class="min-h-screen flex items-center justify-center">
                    <div class="max-w-4xl mx-auto">
                        <!-- Titre principal -->
                        <div class="text-center mb-12">
                            <h1 class="text-6xl font-bold mb-6">
                                <span class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent animate-pulse">
                                    ‚ö° Kimland Sync Pro
                                </span>
                            </h1>
                            <p class="text-xl text-gray-600 font-medium">Synchronisation ultra-rapide Shopify ‚Üî Kimland</p>
                        </div>

                        <!-- Boutons principaux -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                            <!-- Bouton MAJ SKU -->
                            <div class="group cursor-pointer transform transition-all duration-500 hover:scale-105" onclick="updateAllSKU()">
                                <div class="bg-gradient-to-br from-orange-400 via-red-500 to-pink-600 p-8 rounded-3xl shadow-2xl hover:shadow-3xl transition-all duration-500 group-hover:shadow-orange-500/25">
                                    <div class="text-center">
                                        <div class="text-6xl mb-6 transform transition-transform duration-500 group-hover:rotate-12 group-hover:scale-110">
                                            üè∑Ô∏è
                                        </div>
                                        <h3 class="text-2xl font-bold text-white mb-3">Mettre √† jour tous les SKU</h3>
                                        <p class="text-orange-100 text-sm mb-6">Synchronise toutes les r√©f√©rences Kimland avec Shopify</p>
                                        <div class="bg-white/20 backdrop-blur-sm rounded-xl px-4 py-2 inline-block">
                                            <span class="text-white font-semibold">üî• Action Massive</span>
                                        </div>
                                    </div>
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent transform -skew-x-12 translate-x-full group-hover:-translate-x-full transition-transform duration-1000"></div>
                                </div>
                            </div>

                            <!-- Bouton Sync Inventaire -->
                            <div class="group cursor-pointer transform transition-all duration-500 hover:scale-105" onclick="syncAllInventory()">
                                <div class="bg-gradient-to-br from-emerald-400 via-green-500 to-teal-600 p-8 rounded-3xl shadow-2xl hover:shadow-3xl transition-all duration-500 group-hover:shadow-green-500/25">
                                    <div class="text-center">
                                        <div class="text-6xl mb-6 transform transition-transform duration-500 group-hover:rotate-12 group-hover:scale-110">
                                            üì¶
                                        </div>
                                        <h3 class="text-2xl font-bold text-white mb-3">Synchroniser l'inventaire</h3>
                                        <p class="text-green-100 text-sm mb-6">Synchronise tous les stocks en temps r√©el</p>
                                        <div class="bg-white/20 backdrop-blur-sm rounded-xl px-4 py-2 inline-block">
                                            <span class="text-white font-semibold">‚ö° Temps R√©el</span>
                                        </div>
                                    </div>
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent transform -skew-x-12 translate-x-full group-hover:-translate-x-full transition-transform duration-1000"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Zone de recherche rapide -->
                        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
                            <div class="flex items-center justify-center mb-4">
                                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-3 rounded-xl mr-4 shadow-lg animate-pulse">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">üîç Recherche Rapide</h3>
                            </div>
                            
                            <div class="flex gap-4">
                                <input 
                                    type="text" 
                                    id="product-search-input" 
                                    placeholder="Rechercher un produit..."
                                    class="flex-1 px-4 py-3 border-2 border-blue-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-200">
                                <button 
                                    onclick="searchProducts()" 
                                    class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-indigo-700 font-semibold transition-all duration-200 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                    üîç Chercher
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="error" style="display: none;" class="text-center py-12">
                <div class="text-4xl mb-4">‚ùå</div>
                <p class="text-gray-600 mb-4">Erreur de connexion √† votre boutique</p>
                <button onclick="window.location.reload()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700">
                    R√©essayer
                </button>
            </div>
        </main>
    </div>

    <!-- Modal pour le progr√®s de sync -->
    <div id="sync-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Synchronisation en cours</h3>
                <div class="flex items-center space-x-2">
                    <!-- üö´ Bouton d'arr√™t -->
                    <button id="cancel-sync-btn" onclick="cancelSync()" 
                            class="bg-red-600 text-white px-3 py-1 text-sm rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            style="display: none;">
                        üö´ Arr√™ter
                    </button>
                    <button onclick="closeSyncModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                </div>
            </div>
            <div id="sync-progress-container">
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div id="sync-progress-bar" class="sync-progress h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-sm text-gray-600 mb-4" id="sync-status">Pr√©paration...</div>
                <div id="sync-results" class="max-h-60 overflow-y-auto"></div>
                
                <!-- Zone d'information sur l'arr√™t -->
                <div id="cancel-info" class="bg-yellow-50 border border-yellow-200 rounded p-3 mt-4" style="display: none;">
                    <div class="flex items-center">
                        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
                        <span class="text-sm text-yellow-800">Arr√™t en cours... Finalisation des op√©rations actuelles.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentShop = null;
        let syncResults = [];
        let currentTab = 'products';
        // üö´ Variables pour la gestion de l'arr√™t de sync
        let syncAbortController = null;
        let isSyncCancelled = false;

        // Get shop from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentShop = urlParams.get('shop');

        if (!currentShop) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        } else {
            loadDashboard();
        }

        async function loadDashboard() {
            console.log('üöÄ Chargement du dashboard', { currentShop });
            
            try {
                updateStatus('connecting', 'Connexion √† ' + currentShop);
                updateKimlandStatus('checking', 'V√©rification...');
                
                console.log('üì° R√©cup√©ration des produits Shopify', { shop: currentShop });
                const response = await fetch(`/api/products?shop=${encodeURIComponent(currentShop)}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Erreur API produits:', errorData);
                    
                    if (errorData.error === 'AUTH_REQUIRED' && errorData.install_url) {
                        console.log('üîÑ Redirection vers installation Shopify');
                        window.location.href = `/auth/install?shop=${encodeURIComponent(currentShop)}`;
                        return;
                    }
                    
                    throw new Error('Erreur de connexion: ' + (errorData.message || response.statusText));
                }

                const data = await response.json();
                console.log('‚úÖ Donn√©es produits re√ßues:', { success: data.success, productsCount: data.products?.length });
                
                if (data.success) {
                    updateStatus('connected', currentShop);
                    displayProducts(data.products || []);
                    updateStats(data.products || []);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';

                    // Charger l'historique de sync
                    console.log('üìä Chargement historique sync');
                    loadSyncHistory();
                    
                    // V√©rifier la connexion Kimland de fa√ßon d√©taill√©e
                    console.log('üîç V√©rification connexion Kimland');
                    checkKimlandStatusDetailed();
                } else {
                    throw new Error(data.message || 'Erreur inconnue');
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement dashboard:', error);
                updateStatus('error', 'Erreur');
                updateKimlandStatus('error', 'Erreur de chargement');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function switchTab(tabName) {
            // Masquer tous les contenus de tab
            document.querySelectorAll('[id^="tab-content-"]').forEach(el => el.style.display = 'none');
            
            // R√©initialiser tous les boutons de tab
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.className = el.className.replace('border-green-500 text-green-600', 'border-transparent text-gray-500 hover:text-gray-700');
            });
            
            // Activer le tab s√©lectionn√©
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            document.getElementById(`tab-${tabName}`).className = document.getElementById(`tab-${tabName}`).className.replace('border-transparent text-gray-500 hover:text-gray-700', 'border-green-500 text-green-600');
            
            currentTab = tabName;
        }

        function updateStatus(status, shop) {
            const statusEl = document.getElementById('shop-status');
            const colors = {
                connecting: 'bg-yellow-400',
                connected: 'bg-green-400', 
                error: 'bg-red-400'
            };
            
            statusEl.innerHTML = `
                <div class="w-3 h-3 ${colors[status]} rounded-full"></div>
                <span class="text-sm text-gray-600">${shop}</span>
            `;
        }

        function displayProducts(products) {
            // On n'affiche plus la liste, mais on met √† jour les stats
            console.log('üìä Mise √† jour des statistiques:', { totalProducts: products.length });
        }

        function updateStats(products) {
            const withSku = products.filter(p => p.variants?.[0]?.sku);
            const withoutSku = products.filter(p => !p.variants?.[0]?.sku);
            const syncSuccess = syncResults.filter(r => r.syncStatus === 'success').length;
            
            document.getElementById('total-products').textContent = products.length;
            document.getElementById('with-sku').textContent = withSku.length;
            document.getElementById('without-sku').textContent = withoutSku.length;
            document.getElementById('sync-success').textContent = syncSuccess;
            document.getElementById('last-sync').textContent = syncResults.length > 0 ? 'R√©cente' : 'Jamais';
        }

        // üîç Nouvelles fonctions de recherche rapide
        let allShopifyProducts = []; // Cache de tous les produits
        
        async function searchProducts() {
            const searchTerm = document.getElementById('product-search-input').value.trim();
            
            if (!searchTerm || searchTerm.length < 2) {
                alert('üîç Veuillez saisir au moins 2 caract√®res pour la recherche');
                return;
            }
            
            showSearchLoading();
            
            try {
                // üîç NOUVELLE APPROCHE : Recherche directe via API avec le terme
                console.log(`üîç Recherche directe pour: "${searchTerm}"`);
                
                const searchResponse = await fetch(
                    `/api/products/search?shop=${encodeURIComponent(currentShop)}&q=${encodeURIComponent(searchTerm)}`,
                    { method: 'GET' }
                );
                
                if (!searchResponse.ok) {
                    throw new Error(`Erreur de recherche: ${searchResponse.status}`);
                }
                
                const searchData = await searchResponse.json();
                console.log(`‚úÖ Recherche API termin√©e:`, { 
                    success: searchData.success, 
                    resultCount: searchData.products?.length || 0 
                });
                
                if (searchData.success && searchData.products) {
                    displaySearchResults(searchData.products, searchTerm);
                } else {
                    throw new Error(searchData.error || 'Aucun r√©sultat trouv√©');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur recherche:', error);
                hideSearchLoading();
                alert('‚ùå Erreur lors de la recherche: ' + error.message);
            }
        }
        
        function displaySearchResults(products, searchTerm) {
            hideSearchLoading();
            
            const resultsContainer = document.getElementById('search-results');
            const resultsList = document.getElementById('search-results-list');
            const resultsCount = document.getElementById('results-count');
            const searchCounter = document.getElementById('search-counter');
            
            // Mettre √† jour les compteurs
            if (resultsCount) {
                resultsCount.textContent = `${products.length} produit(s)`;
            }
            if (searchCounter) {
                searchCounter.textContent = `${products.length} r√©sultats`;
                searchCounter.classList.remove('hidden');
            }
            
            if (products.length === 0) {
                resultsList.innerHTML = `
                    <div class="p-8 text-center bg-gray-50">
                        <div class="text-6xl mb-4">üîç</div>
                        <div class="text-xl font-semibold text-gray-700 mb-2">Aucun produit trouv√©</div>
                        <div class="text-gray-500 mb-4">Essayez avec d'autres mots-cl√©s pour "<span class="font-semibold">${searchTerm}</span>"</div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto">
                            <div class="text-sm text-blue-800">
                                <strong>üìù Suggestions :</strong><br>
                                ‚Ä¢ V√©rifiez l'orthographe<br>
                                ‚Ä¢ Utilisez des termes plus g√©n√©raux<br>
                                ‚Ä¢ Essayez avec le SKU/r√©f√©rence exact
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const limitedProducts = products.slice(0, 20); // Limite √† 20 r√©sultats
                
                resultsList.innerHTML = limitedProducts.map((product, index) => {
                    const totalStock = product.variants?.reduce((total, v) => total + (v.inventory_quantity || 0), 0) || 0;
                    const hasSku = product.variants?.[0]?.sku;
                    const stockColor = totalStock > 0 ? 'text-green-600' : 'text-red-600';
                    const stockIcon = totalStock > 0 ? 'üì¶' : 'üì≠';
                    
                    return `
                    <div class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200 group">
                        <div class="p-6 flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-start justify-between mb-3">
                                    <h4 class="font-bold text-lg text-gray-900 group-hover:text-blue-800 transition-colors line-clamp-2">${product.title}</h4>
                                    <div class="ml-4 text-xs text-gray-400 font-mono">#${index + 1}</div>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-blue-600">üÜî</span>
                                        <span class="text-sm font-mono text-gray-600">${product.id}</span>
                                    </div>
                                    
                                    <div class="flex items-center space-x-2">
                                        ${hasSku ? `
                                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center">
                                                <span class="mr-1">üè∑Ô∏è</span>
                                                ${product.variants[0].sku}
                                            </span>
                                        ` : `
                                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center">
                                                <span class="mr-1">‚ö†Ô∏è</span>
                                                Pas de SKU
                                            </span>
                                        `}
                                    </div>
                                    
                                    <div class="flex items-center space-x-2">
                                        <span class="${stockColor}">${stockIcon}</span>
                                        <span class="text-sm font-semibold ${stockColor}">Stock: ${totalStock}</span>
                                    </div>
                                </div>
                                
                                <div class="text-xs text-gray-500">
                                    ${product.variants?.length || 0} variante(s) ‚Ä¢ 
                                    Cr√©√© le ${new Date(product.created_at).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                            
                            <div class="ml-6 flex flex-col space-y-2">
                                ${hasSku ? `
                                    <button 
                                        onclick="syncProductFromSearch(${product.id}, '${product.title.replace(/'/g, "\\'")}')"
                                        class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-600 hover:to-emerald-700 font-semibold transition-all duration-200 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 group">
                                        <svg class="w-5 h-5 mr-2 group-hover:animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span class="hidden sm:inline">Synchroniser</span>
                                        <span class="sm:hidden">Sync</span>
                                    </button>
                                    <button 
                                        onclick="updateProductSKU(${product.id}, '${product.title.replace(/'/g, "\'")}')"  
                                        class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-red-700 font-medium transition-all duration-200 flex items-center shadow-md hover:shadow-lg mb-2">
                                        <span class="mr-1">üîß</span>
                                        <span class="hidden sm:inline text-sm">MAJ SKU</span>
                                        <span class="sm:hidden text-xs">SKU</span>
                                    </button>
                                ` : `
                                    <button 
                                        onclick="updateProductSKU(${product.id}, '${product.title.replace(/'/g, "\'")}')"  
                                        class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-blue-600 hover:to-indigo-700 font-semibold transition-all duration-200 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-1 mb-2">
                                        <span class="mr-2">üè∑Ô∏è</span>
                                        <span class="hidden sm:inline">Ajouter SKU</span>
                                        <span class="sm:hidden">SKU</span>
                                    </button>
                                `}
                                
                                <button 
                                    onclick="viewProductDetails(${product.id})"
                                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 font-medium transition-all duration-200 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <span class="text-xs">Voir</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join('');
                
                if (products.length > 20) {
                    resultsList.innerHTML += `
                        <div class="p-4 bg-blue-50 text-center text-blue-800">
                            üìä ${products.length - 20} autres produits trouv√©s. Affinez votre recherche pour voir plus de r√©sultats.
                        </div>
                    `;
                }
            }
            
            resultsContainer.classList.remove('hidden');
        }
        
        // üîç Nouvelle fonction pour vider la recherche
        function clearSearch() {
            const searchInput = document.getElementById('product-search-input');
            const resultsContainer = document.getElementById('search-results');
            const searchCounter = document.getElementById('search-counter');
            
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            
            if (resultsContainer) {
                resultsContainer.classList.add('hidden');
            }
            
            if (searchCounter) {
                searchCounter.classList.add('hidden');
            }
            
            console.log('üßπ Recherche vid√©e');
        }
        
        // üëÅÔ∏è Nouvelle fonction pour voir les d√©tails d'un produit
        function viewProductDetails(productId) {
            const product = allShopifyProducts.find(p => p.id == productId);
            if (!product) {
                alert('‚ùå Produit non trouv√©');
                return;
            }
            
            const variants = product.variants || [];
            const totalStock = variants.reduce((total, v) => total + (v.inventory_quantity || 0), 0);
            
            const detailsHtml = `
                üì¶ Produit: ${product.title}
                üÜî ID: ${product.id}
                üè∑Ô∏è SKU: ${variants[0]?.sku || 'Non d√©fini'}
                üìä Stock total: ${totalStock}
                üî¢ Variantes: ${variants.length}
                üìÖ Cr√©√© le: ${new Date(product.created_at).toLocaleDateString('fr-FR')}
                üí∞ Prix: ${variants[0]?.price || 'N/A'} ‚Ç¨
                
                Variantes:
                ${variants.map((v, i) => `
                ‚Ä¢ Variante ${i + 1}: ${v.title || 'Sans titre'}
                  SKU: ${v.sku || 'Non d√©fini'}
                  Stock: ${v.inventory_quantity || 0}
                  Prix: ${v.price || 'N/A'} ‚Ç¨`).join('')}
            `;
            
            alert(detailsHtml);
        }
        
        async function syncProductFromSearch(productId, productTitle) {
            if (!confirm(`üîÑ Synchroniser le produit "${productTitle}" avec Kimland ?`)) {
                return;
            }
            
            try {
                // Utiliser la fonction existante
                await syncProductInventory(productId);
                
                // Actualiser la recherche pour voir les changements
                await searchProducts();
                
            } catch (error) {
                console.error('‚ùå Erreur sync depuis recherche:', error);
            }
        }
        
        function showSearchLoading() {
            document.getElementById('search-loading').classList.remove('hidden');
            document.getElementById('search-results').classList.add('hidden');
        }
        
        function hideSearchLoading() {
            document.getElementById('search-loading').classList.add('hidden');
        }
        
        // Recherche en temps r√©el avec d√©lai
        let searchTimeout;
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('product-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const value = this.value.trim();
                    
                    if (value.length >= 3) {
                        searchTimeout = setTimeout(() => {
                            searchProducts();
                        }, 500); // Attendre 500ms apr√®s la derni√®re saisie
                    } else if (value.length === 0) {
                        // Cacher les r√©sultats si le champ est vide
                        document.getElementById('search-results').classList.add('hidden');
                    }
                });
                
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchProducts();
                    }
                });
            }
        });
        
        async function syncProductInventory(productId) {
            try {
                console.log('üì¶ D√©but sync produit:', { productId, shop: currentShop });
                
                const response = await fetch(`/api/sync/product/${productId}?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'POST'
                });
                
                console.log('üì° R√©ponse sync produit:', { ok: response.ok, status: response.status });
                
                const result = await response.json();
                console.log('üì• Donn√©es sync produit:', result);
                
                if (result.success) {
                    console.log('‚úÖ Sync produit r√©ussie:', result);
                    alert(`Stock synchronis√© avec succ√®s!\nSKU: ${result.syncResult?.sku}\nStock Kimland: ${result.kimlandStock}\nStock mis √† jour sur Shopify: ${result.updatedQuantity}`);
                    loadDashboard();
                } else {
                    console.error('‚ùå Sync produit √©chou√©e:', result);
                    
                    // Afficher d√©tails de l'erreur si c'est une erreur d'auth Kimland
                    let errorMsg = result.error || 'Erreur inconnue';
                    if (result.syncResult?.errorMessage) {
                        errorMsg += '\nD√©tail: ' + result.syncResult.errorMessage;
                    }
                    
                    alert(`‚ùå Erreur de synchronisation: ${errorMsg}\n\nD√©bogage: ${JSON.stringify(result.syncResult, null, 2)}`);
                    
                    // Si c'est une erreur d'auth, v√©rifier le statut Kimland
                    if (result.syncResult?.errorMessage?.includes('authentification')) {
                        console.log('üîç Erreur auth d√©tect√©e, v√©rification statut Kimland');
                        checkKimlandStatusDetailed();
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau sync produit:', error);
                alert('‚ùå Erreur de connexion lors de la synchronisation: ' + error.message);
            }
        }

        async function syncAllInventory() {
            if (!confirm('Synchroniser l\'inventaire de tous les produits avec Kimland ?')) {
                return;
            }

            // R√©initialiser les variables d'arr√™t
            isSyncCancelled = false;
            syncAbortController = new AbortController();

            showSyncModal();
            
            try {
                const response = await fetch(`/api/sync/inventory/all?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'POST',
                    signal: syncAbortController.signal // Ajouter le signal d'arr√™t
                });
                
                if (!response.ok) {
                    throw new Error('Erreur de synchronisation');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                let buffer = '';
                while (true) {
                    // V√©rifier l'annulation avant chaque lecture
                    if (isSyncCancelled) {
                        console.log('üö´ Arr√™t de la lecture demand√©');
                        reader.cancel(); // Annuler la lecture du stream
                        break;
                    }
                    
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Garder la ligne incompl√®te

                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const data = JSON.parse(line);
                                updateSyncProgress(data);
                                
                                // Arr√™ter si on re√ßoit un message d'annulation
                                if (data.type === 'cancelled') {
                                    console.log('üö´ Synchronisation annul√©e par le serveur');
                                    isSyncCancelled = true;
                                    break;
                                }
                            } catch (e) {
                                console.log('Non-JSON line:', line);
                            }
                        }
                    }
                    
                    if (isSyncCancelled) break;
                }

                // Traiter la derni√®re ligne si elle existe
                if (buffer.trim() && !isSyncCancelled) {
                    try {
                        const data = JSON.parse(buffer);
                        updateSyncProgress(data);
                    } catch (e) {
                        console.log('Non-JSON final line:', buffer);
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('üö´ Synchronisation annul√©e par l\'utilisateur');
                    updateSyncStatus('üö´ Synchronisation arr√™t√©e par l\'utilisateur');
                } else {
                    console.error('Erreur sync globale:', error);
                    updateSyncStatus('Erreur de synchronisation: ' + error.message);
                }
            } finally {
                // Nettoyer apr√®s la synchronisation
                syncAbortController = null;
                hideCancelButton();
            }
        }

        function showSyncModal() {
            document.getElementById('sync-modal').style.display = 'block';
            document.getElementById('sync-progress-bar').style.width = '0%';
            document.getElementById('sync-status').textContent = 'Pr√©paration...';
            document.getElementById('sync-results').innerHTML = '';
            
            // Masquer les √©l√©ments d'arr√™t initialement
            hideCancelButton();
            hideCancelInfo();
        }

        function closeSyncModal() {
            // Si une synchronisation est en cours, demander confirmation
            if (syncAbortController && !isSyncCancelled) {
                if (confirm('üö´ Voulez-vous vraiment arr√™ter la synchronisation en cours ?')) {
                    cancelSync();
                } else {
                    return; // Ne pas fermer si l'utilisateur annule
                }
            }
            
            document.getElementById('sync-modal').style.display = 'none';
            loadDashboard(); // Recharger les donn√©es
        }

function updateSyncProgress(data) {
console.log('üìä Progr√®s sync re√ßu:', data);

if (data.type === 'info') {
updateSyncStatus(`‚ÑπÔ∏è ${data.message}`);
    
// Afficher le bouton d'arr√™t si la synchronisation peut √™tre annul√©e
if (data.canCancel) {
    showCancelButton();
}

} else if (data.type === 'progress') {
const progress = data.percentage || Math.round((data.current / data.total) * 100);

// üìä Mise √† jour de la barre de progression
const progressBar = document.getElementById('sync-progress-bar');
if (progressBar) {
progressBar.style.width = progress + '%';
progressBar.style.transition = 'width 0.3s ease';
}

// üìù Mise √† jour du status avec plus de d√©tails
    updateSyncStatus(`
    üîÑ ${data.message} 
    <br><small>${data.current}/${data.total} (${progress}%)</small>
    ${data.productName ? `<br><small>üì¶ ${data.productName}</small>` : ''}
`);

// Afficher le bouton d'arr√™t si possible
if (data.canCancel) {
    showCancelButton();
}

} else if (data.type === 'result') {
const resultDiv = document.getElementById('sync-results');
if (!resultDiv) return;

const timestamp = new Date(data.timestamp).toLocaleTimeString();
const statusClass = data.success ? 'text-green-600' : 'text-red-600';
const statusIcon = data.success ? '‚úÖ' : '‚ùå';

// üé® HTML am√©lior√© pour les r√©sultats
const resultHtml = `
<div class="sync-result-item border-l-4 ${data.success ? 'border-green-400' : 'border-red-400'} pl-3 py-2 mb-2 bg-gray-50 rounded">
<div class="flex justify-between items-start">
<div class="flex-1">
<div class="flex items-center">
    <span class="${statusClass} text-lg mr-2">${statusIcon}</span>
        <strong class="text-sm">${data.sku}</strong>
            <span class="text-xs text-gray-500 ml-2">${timestamp}</span>
            </div>
                ${data.productName ? `<div class="text-xs text-gray-600 ml-6">${data.productName}</div>` : ''}
                <div class="text-sm ml-6 ${statusClass}">${data.message}</div>
                ${data.kimlandStock !== undefined ? `
                    <div class="text-xs text-blue-600 ml-6">
                        üì¶ Stock: ${data.kimlandStock} 
                            ${data.variantsCount ? `| ${data.variantsCount} variante(s)` : ''}
                    </div>
                ` : ''}
            </div>
        </div>
    </div>
`;

resultDiv.insertAdjacentHTML('beforeend', resultHtml);
resultDiv.scrollTop = resultDiv.scrollHeight;

} else if (data.type === 'cancelled') {
// üö´ Synchronisation annul√©e
updateSyncStatus(`
    üö´ <strong>Synchronisation arr√™t√©e!</strong>
<br>Arr√™t√©e √† l'√©tape ${data.stoppedAt || 0}
`);

hideCancelButton();
showCancelInfo('Synchronisation arr√™t√©e par l\'utilisateur');

// üîî Notification
if ('Notification' in window && Notification.permission === 'granted') {
new Notification('Synchronisation arr√™t√©e', {
        body: `Synchronisation interrompue √† l'√©tape ${data.stoppedAt || 0}`,
        icon: '/favicon.ico'
        });
}

} else if (data.type === 'complete') {
        // üèÅ Finalisation avec statistiques d√©taill√©es
                const successRate = data.successRate || 0;
                const duration = Math.round((data.duration || 0) / 1000);
                
                updateSyncStatus(`
                    üèÅ <strong>Synchronisation termin√©e!</strong>
                    <br>‚úÖ ${data.successful} r√©ussies 
                    <br>‚ùå ${data.failed} √©checs 
                    <br>üìä Taux de r√©ussite: ${successRate}%
                    <br>‚è±Ô∏è Dur√©e: ${duration}s
                `);
                
                hideCancelButton();
                
                // üîî Notification syst√®me si disponible
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Synchronisation termin√©e', {
                        body: `${data.successful}/${data.total} produits synchronis√©s avec succ√®s`,
                        icon: '/favicon.ico'
                    });
                }
                
                // üìä Mettre √† jour les statistiques du dashboard
                setTimeout(() => {
                    loadDashboard();
                }, 2000);
                
            } else if (data.type === 'error') {
                updateSyncStatus(`üí• <strong>Erreur critique:</strong><br>${data.message}`);
                hideCancelButton();
                console.error('Erreur sync critique:', data);
            }
        }

function updateSyncStatus(html) {
const statusEl = document.getElementById('sync-status');
if (statusEl) {
statusEl.innerHTML = html;
}
}

        // üö´ Nouvelles fonctions pour g√©rer l'arr√™t de synchronisation
        function cancelSync() {
            console.log('üö´ cancelSync() appel√©e - D√©but de la fonction');
            
            if (!syncAbortController || isSyncCancelled) {
                console.log('‚ö†Ô∏è Aucune synchronisation √† annuler', { 
                    hasSyncAbortController: !!syncAbortController, 
                    isSyncCancelled 
                });
                return;
            }
            
            console.log('üö´ D√©but annulation synchronisation');
            isSyncCancelled = true;
            
            // Annuler la requ√™te HTTP
            if (syncAbortController) {
                console.log('üö´ Appel de syncAbortController.abort()');
                syncAbortController.abort();
                syncAbortController = null;
            }
            
            // Afficher le message d'arr√™t
            showCancelInfo('Arr√™t en cours... Finalisation des op√©rations actuelles.');
            
            // D√©sactiver le bouton
            const cancelBtn = document.getElementById('cancel-sync-btn');
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = '‚è≥ Arr√™t...';
                console.log('üö´ Bouton d√©sactiv√© et texte chang√©');
            } else {
                console.error('‚ùå Bouton cancel-sync-btn non trouv√©!');
            }
            
            updateSyncStatus('üö´ Arr√™t de la synchronisation en cours...');
            console.log('üö´ Fin de cancelSync()');
        }
        
        function showCancelButton() {
            console.log('üö´ showCancelButton() appel√©e');
            const cancelBtn = document.getElementById('cancel-sync-btn');
            if (cancelBtn && !isSyncCancelled) {
                cancelBtn.style.display = 'inline-block';
                cancelBtn.disabled = false;
                cancelBtn.innerHTML = 'üö´ Arr√™ter';
                console.log('‚úÖ Bouton d\'arr√™t affich√©');
            } else {
                console.log('‚ö†Ô∏è Bouton non affich√©:', { 
                    hasBtn: !!cancelBtn, 
                    isSyncCancelled 
                });
            }
        }
        
        function hideCancelButton() {
            const cancelBtn = document.getElementById('cancel-sync-btn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
        }
        
        function showCancelInfo(message) {
            const cancelInfo = document.getElementById('cancel-info');
            if (cancelInfo) {
                cancelInfo.style.display = 'block';
                const messageSpan = cancelInfo.querySelector('.text-yellow-800');
                if (messageSpan) {
                    messageSpan.textContent = message;
                }
            }
        }
        
        function hideCancelInfo() {
            const cancelInfo = document.getElementById('cancel-info');
            if (cancelInfo) {
                cancelInfo.style.display = 'none';
            }
        }

// üîî Demander permission pour notifications
window.addEventListener('load', () => {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

        async function loadSyncHistory() {
            try {
                const response = await fetch(`/api/sync/history?shop=${encodeURIComponent(currentShop)}`);
                const historyData = await response.json();
                
                if (historyData.success && historyData.history.length > 0) {
                    const container = document.getElementById('sync-history-list');
                    container.innerHTML = historyData.history.map(sync => `
                        <div class="px-6 py-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm font-medium text-gray-900">
                                        ${new Date(sync.date).toLocaleString('fr-FR')}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        ${sync.successful} r√©ussies, ${sync.failed} √©checs
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm ${sync.status === 'completed' ? 'text-green-600' : 'text-red-600'}">
                                        ${sync.status === 'completed' ? '‚úÖ Termin√©' : '‚ùå Erreur'}
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        ${sync.duration}ms
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Erreur chargement historique:', error);
            }
        }

        // Fonction de mise √† jour du statut Kimland
        function updateKimlandStatus(status, message, details = null) {
            console.log('üîÑ Mise √† jour statut Kimland:', { status, message, details });
            
            const banner = document.getElementById('kimland-connection-banner');
            const icon = document.getElementById('kimland-connection-icon');
            const statusEl = document.getElementById('kimland-connection-status');
            const detailsEl = document.getElementById('kimland-connection-details');
            const statEl = document.getElementById('kimland-status');
            
            // Mise √† jour des couleurs et ic√¥nes
            const configs = {
                connected: {
                    bannerClass: 'border-green-400',
                    iconClass: 'w-4 h-4 bg-green-400 rounded-full mr-3',
                    stat: 'üü¢ OK'
                },
                error: {
                    bannerClass: 'border-red-400',
                    iconClass: 'w-4 h-4 bg-red-400 rounded-full mr-3',
                    stat: 'üî¥ KO'
                },
                checking: {
                    bannerClass: 'border-orange-400',
                    iconClass: 'w-4 h-4 bg-orange-400 rounded-full mr-3 animate-pulse',
                    stat: 'üü° ...'
                },
                disconnected: {
                    bannerClass: 'border-red-400',
                    iconClass: 'w-4 h-4 bg-red-400 rounded-full mr-3',
                    stat: '‚ö´ OFF'
                }
            };
            
            const config = configs[status] || configs.error;
            
            // Mettre √† jour l'apparence
            banner.className = `bg-white rounded-lg shadow mb-6 border-l-4 ${config.bannerClass}`;
            icon.className = config.iconClass;
            statusEl.textContent = message;
            statEl.textContent = config.stat;
            
            // Afficher les d√©tails si disponibles
            if (details) {
                detailsEl.innerHTML = `
                    <div class="bg-gray-50 p-2 rounded mt-2">
                        <pre class="text-xs">${JSON.stringify(details, null, 2)}</pre>
                    </div>
                `;
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
            }
        }

        async function checkKimlandStatusDetailed() {
            try {
                console.log('üîç D√©but v√©rification statut Kimland d√©taill√©e');
                updateKimlandStatus('checking', 'V√©rification connexion Kimland...');
                
                const response = await fetch('/api/kimland/status');
                console.log('üì° R√©ponse API kimland/status:', { 
                    ok: response.ok, 
                    status: response.status, 
                    statusText: response.statusText 
                });
                
                const statusData = await response.json();
                console.log('üì• Donn√©es statut Kimland:', statusData);
                
                // Mise √† jour des √©l√©ments de l'interface
                const indicator = document.getElementById('kimland-status-indicator');
                const text = document.getElementById('kimland-status-text');
                
                if (statusData.connected) {
                    console.log('‚úÖ Kimland connect√©');
                    updateKimlandStatus('connected', `Connect√© depuis ${statusData.timestamp ? new Date(statusData.timestamp).toLocaleTimeString() : 'maintenant'}`, statusData);
                    
                    if (indicator) {
                        indicator.className = 'w-3 h-3 bg-green-400 rounded-full mr-2';
                    }
                    if (text) {
                        text.textContent = 'Connect√©';
                    }
                } else {
                    console.log('‚ùå Kimland d√©connect√©:', statusData.error);
                    updateKimlandStatus('disconnected', `D√©connect√©: ${statusData.error || 'Raison inconnue'}`, statusData);
                    
                    if (indicator) {
                        indicator.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                    }
                    if (text) {
                        text.textContent = 'D√©connect√©';
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erreur v√©rification Kimland:', error);
                updateKimlandStatus('error', `Erreur de v√©rification: ${error.message}`, { error: error.toString() });
                
                const indicator = document.getElementById('kimland-status-indicator');
                const text = document.getElementById('kimland-status-text');
                
                if (indicator) {
                    indicator.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                }
                if (text) {
                    text.textContent = 'Erreur de v√©rification';
                }
            }
        }

        async function testKimlandConnection() {
            try {
                console.log('üîó D√©but test connexion Kimland');
                updateKimlandStatus('checking', 'Test de connexion en cours...');
                
                const response = await fetch('/api/kimland/test', { method: 'POST' });
                console.log('üì° R√©ponse test Kimland:', { ok: response.ok, status: response.status });
                
                const testData = await response.json();
                console.log('üì• Donn√©es test Kimland:', testData);
                
                if (testData.success) {
                    console.log('‚úÖ Test connexion Kimland r√©ussi');
                    updateKimlandStatus('connected', 'Test r√©ussi - Connexion op√©rationnelle', testData);
                    alert('‚úÖ Connexion Kimland r√©ussie!\n' + JSON.stringify(testData, null, 2));
                    checkKimlandStatusDetailed();
                } else {
                    console.error('‚ùå Test connexion Kimland √©chou√©:', testData);
                    updateKimlandStatus('error', `Test √©chou√©: ${testData.error}`, testData);
                    alert('‚ùå Erreur de connexion: ' + testData.error + '\nD√©tails: ' + JSON.stringify(testData, null, 2));
                }
            } catch (error) {
                console.error('‚ùå Erreur test connexion Kimland:', error);
                updateKimlandStatus('error', 'Erreur durant le test', { error: error.toString() });
                alert('‚ùå Erreur de test de connexion: ' + error.message);
            }
        }
        
        async function forceReconnectKimland() {
            if (!confirm('Forcer une reconnexion √† Kimland ?\nCela va vider la session actuelle.')) {
                return;
            }
            
            try {
                console.log('üîÑ D√©but reconnexion forc√©e Kimland');
                updateKimlandStatus('checking', 'Reconnexion forc√©e en cours...');
                
                // Vider la session actuelle
                const clearResponse = await fetch('/api/kimland/clear-session', { method: 'POST' });
                const clearData = await clearResponse.json();
                console.log('üóëÔ∏è Session vid√©e:', clearData);
                
                // Forcer une nouvelle connexion
                const loginResponse = await fetch('/api/kimland/force-login', { method: 'POST' });
                const loginData = await loginResponse.json();
                console.log('üîê Reconnexion forc√©e:', loginData);
                
                if (loginData.success) {
                    console.log('‚úÖ Reconnexion Kimland r√©ussie');
                    updateKimlandStatus('connected', 'Reconnexion r√©ussie', loginData);
                    alert('‚úÖ Reconnexion Kimland r√©ussie!');
                    checkKimlandStatusDetailed();
                } else {
                    console.error('‚ùå Reconnexion Kimland √©chou√©e:', loginData);
                    updateKimlandStatus('error', `Reconnexion √©chou√©e: ${loginData.error}`, loginData);
                    alert('‚ùå Erreur de reconnexion: ' + loginData.error);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur reconnexion forc√©e Kimland:', error);
                updateKimlandStatus('error', 'Erreur durant la reconnexion', { error: error.toString() });
                alert('‚ùå Erreur de reconnexion: ' + error.message);
            }
        }

        async function clearKimlandSession() {
            if (!confirm('Vider la session Kimland ?')) return;
            
            try {
                const response = await fetch('/api/kimland/clear-session', { method: 'POST' });
                const sessionData = await response.json();
                
                if (sessionData.success) {
                    alert('‚úÖ Session vid√©e');
                    checkKimlandStatus();
                } else {
                    alert('‚ùå Erreur: ' + sessionData.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors du vidage de session');
            }
        }

        function refreshData() {
            loadDashboard();
        }

        function exportData() {
            // TODO: Impl√©menter l'export
            alert('Fonctionnalit√© d\'export bient√¥t disponible!');
        }

        // Fonctions de mise √† jour SKU
        async function updateSKU(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/update-sku?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`SKU mis √† jour avec succ√®s: ${result.reference}`);
                    loadDashboard();
                } else {
                    alert(`Erreur: ${result.error}`);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // Nouvelle fonction pour mettre √† jour le SKU d'un produit sp√©cifique
        async function updateProductSKU(productId, productTitle) {
            if (!confirm(`Mettre √† jour le SKU/r√©f√©rence pour "${productTitle}" ?\nCeci va rechercher et appliquer la r√©f√©rence Kimland correspondante.`)) {
                return;
            }
            
            try {
                console.log('üè∑Ô∏è D√©but mise √† jour SKU produit:', { productId, productTitle });
                
                const response = await fetch(`/api/products/${productId}/update-sku?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                console.log('üì• R√©sultat mise √† jour SKU:', result);
                
                if (result.success) {
                    alert(`‚úÖ SKU mis √† jour avec succ√®s!\nProduit: ${productTitle}\nNouveau SKU: ${result.reference}`);
                    
                    // Actualiser la recherche pour voir les changements
                    await searchProducts();
                } else {
                    alert(`‚ùå Erreur lors de la mise √† jour du SKU:\n${result.error}`);
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau mise √† jour SKU:', error);
                alert('‚ùå Erreur de connexion lors de la mise √† jour du SKU: ' + error.message);
            }
        }

        async function updateAllSKU() {
            if (!confirm('Mettre √† jour le SKU de TOUS les produits avec r√©f√©rences ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/products/update-all-sku?shop=${encodeURIComponent(currentShop)}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Mise √† jour termin√©e:\n- ${result.updated} SKU mis √† jour\n- ${result.skipped} produits ignor√©s`);
                    loadDashboard();
                } else {
                    alert(`Erreur: ${result.error}`);
                }
            } catch (error) {
                alert('Erreur de connexion');
            }
        }

        // Support touche Entr√©e pour la recherche
        document.getElementById('search-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    // TODO: Impl√©menter la recherche
                    console.log('Recherche:', searchTerm);
                }
            }
        });

        // Fermer le modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('sync-modal');
            if (event.target === modal) {
                closeSyncModal();
            }
        }
    </script>
</body>
</html>